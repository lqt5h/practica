# Отчёт о сканировании контейнеров
## Ветка feat/container-scanning-trivy
  
**Статус:**  **Завершено**  
**Проект:** course-management (Spring Boot 3.5.6)

---

## Резюме

Успешно реализован автоматизированный контроль безопасности образов контейнеров с помощью Trivy в CI/CD pipeline GitHub Actions. Workflow блокирует сборку при обнаружении HIGH/CRITICAL уязвимостей перед публикацией образов в GHCR.

---

## Выполненные работы

### 1. **Исправление уязвимостей зависимостей** 

#### Проблема
Spring Boot 3.5.4 содержал HIGH-severity CVE в:
- `tomcat-embed-core` 10.1.43 → требуется 10.1.45+
- `spring-security-core` 6.5.2 → требуется 6.5.5+
- `spring-core` (transitive)

#### Применённое решение
**Обновлено `pom.xml`:**
```xml
<parent>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-parent</artifactId>
  <version>3.5.6</version>  <!-- было 3.5.4 -->
  <relativePath/>
</parent>

<properties>
  <java.version>21</java.version>
  <spring-security.version>6.5.5</spring-security.version>
  <tomcat.version>10.1.45</tomcat.version>
</properties>
```

**Результат:** Все HIGH уязвимости из анализа зависимостей устранены.

---

### 2. **Усиление безопасности Dockerfile** 

#### Проблема
Контейнер работал под пользователем `root` (нарушение CIS Docker Benchmark и Semgrep).

#### Применённое решение
**Реализовано выполнение от непривилегированного пользователя:**
```dockerfile
# Создание непривилегированного пользователя
RUN groupadd -r app && useradd -r -g app app

# Установка прав доступа
COPY --from=build /app/target/*.jar /app/app.jar
RUN chown -R app:app /app

# Запуск от непривилегированного пользователя
USER app

EXPOSE 8080
ENTRYPOINT ["java","-jar","/app/app.jar"]
```

**Результат:** 
-  Passed Semgrep rule `dockerfile.security.missing-user-entrypoint`
-  Снижена атака поверхность контейнера
-  Соответствие Docker security best practices

---

### 3. **GitHub Actions CI/CD Pipeline** 

#### Реализованный Workflow: `build_scan_push`
Многоэтапный pipeline с security gates:

| Этап | Инструмент | Назначение | Блокировка |
|------|-----------|-----------|-----------|
| Build | Maven 21 JDK | Сборка & упаковка JAR | Fail on error |
| Image Build | Docker | Создание OCI образа | Fail on error |
| Security Scan | Trivy | Сканирование уязвимостей | ⛔ **Fail on HIGH/CRITICAL** |
| Push | GHCR | Публикация в реестр | Только если scan passed |

#### Ключевая конфигурация
```yaml
- name: Run Trivy vulnerability scan
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'ghcr.io/...:${{ github.sha }}'
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'HIGH,CRITICAL'
    exit-code: '1'  # Fail если найдены уязвимости

- name: Push image to GHCR (only if scan passed)
  if: success()  # Выполняется только если Trivy passed
  run: docker push ghcr.io/.../practica:${{ github.sha }}
```

**Результат:** Сборка прерывается перед публикацией если найдены HIGH/CRITICAL.

---

## Проверка и верификация

### Статус CI/CD
-  Job: `build_scan_push` — **SUCCEEDED**
-  Все 11 шагов выполнены успешно
-  Образ опубликован в GHCR
-  Trivy scan passed (без HIGH/CRITICAL)
-  Semgrep code scanning passed

### Деталь образа контейнера
- **Реестр:** GHCR (ghcr.io)
- **Base Images:** 
  - Build: `eclipse-temurin:21-jdk`
  - Runtime: `eclipse-temurin:21-jre`
- **Пользователь:** `app:app` (non-root)
- **Порт:** 8080
- **Триггер push:** После успешного Trivy scan

---

## Таблица улучшений безопасности

| Контроль | До | После |
|---------|----|----|
| **Dependency CVEs (HIGH)** | 3+ обнаружено | Исправлено |
| **Spring Boot Version** | 3.5.4 | 3.5.6 |
| **Tomcat Version** | 10.1.43 | 10.1.45 |
| **Spring Security** | 6.5.2 | 6.5.5 |
| **Container User** | root | app (non-root)  |
| **Image Scanning** | Нет | Trivy (gated)  |
| **Semgrep Check** | Failed | Passed  |
| **Registry Access** | N/A | GHCR с auto-scan  |

---

## Технические детали

### Инструменты и версии
- **Container Scanning:** Aquasec Trivy v0.48+ (SARIF output)
- **Dependency Check:** Maven (managed by Spring Boot BOM)
- **Code Scanning:** Semgrep OSS (GitHub code-scanning integration)
- **Base Image:** Eclipse Temurin 21 (с security patches)
- **Build Tool:** Maven Wrapper (./mvnw)

### Модифицированные файлы конфигурации
1. **`pom.xml`** — Upgrade parent версии, добавлены property overrides
2. **`Dockerfile`** — Multi-stage build, non-root user, исправления прав доступа
3. **`.github/workflows/build_scan_push.yml`** — Trivy scan + GHCR push gating

---

## Соответствие стандартам

 **CIS Docker Benchmark:** Container Security Profile  
 **OWASP:** Dependency checking (pom.xml managed versions)  
 **GitHub Security Best Practices:** Code + container scanning включены  
 **DevSecOps:** Shift-left security (scan перед публикацией)

---

## Возможные улучшения (опционально)

- [ ] Включить полный набор Semgrep rules (SAST + secrets)
- [ ] Добавить runtime scanning (Falco/Sysdig)
- [ ] Реализовать SBOM generation (cyclonedx format)
- [ ] Добавить image signature verification (Cosign)
- [ ] Включить CVE alerting на новые уязвимости

---

## Заключение

Pipeline контроля безопасности контейнеров теперь **готов к продакшену** с:
-  Автоматизированное обнаружение уязвимостей (Trivy)
-  Блокировка сборки при критических уязвимостях
-  Выполнение от непривилегированного пользователя (hardened Dockerfile)
-  Управление версиями зависимостей (Spring Boot BOM)
-  Безопасная публикация образов (GHCR с security gating)

Все три этапа CI/CD (build → scan → push) работают и passing.

---
 
**Ветка:** `feat/container-scanning-trivy`  